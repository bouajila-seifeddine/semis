<?php
 /**
  * Prestashop Modules & Themen End User License Agreement  *   * This End User License Agreement ("EULA") is a legal agreement between you and Presta-Apps ltd.( herein referred to as "we" or "us" ) with regard to Prestashop Modules & Themen (herein referred to as "Software Product" or "Software"). By installing or using the Software Product you agree to be bound by the terms of this EULA.  *   *    1. Eligible Licensees. This Software is available for license solely to Software Owners, with no right of duplication or further distribution, licensing, or sub-licensing. A Software Owner is someone who legally obtained a copy of the Software Product via Prestashop Store.  *    2. License Grant. We grant you a personal/one commercial, non-transferable and non-exclusive right to use the copy of the Software obtained via Prestashop Store. Modifying, translating, renting, copying, transferring or assigning all or part of the Software, or any rights granted hereunder, to any other persons and removing any proprietary notices, labels or marks from the Software is strictly prohibited. Furthermore, you hereby agree not to create derivative works based on the Software. You may not transfer this Software.  *    3. Copyright. The Software is licensed, not sold. You acknowledge that no title to the intellectual property in the Software is transferred to you. You further acknowledge that title and full ownership rights to the Software will remain the exclusive property of Presta-Apps Mobile, and you will not acquire any rights to the Software, except as expressly set forth above.  *    4. Reverse Engineering. You agree that you will not attempt, and if you are a corporation, you will use your best efforts to prevent your employees and contractors from attempting to reverse compile, modify, translate or disassemble the Software in whole or in part. Any failure to comply with the above or any other terms and conditions contained herein will result in the automatic termination of this license.  *    5. Disclaimer of Warranty. The Software is provided "AS IS" without warranty of any kind. We disclaim and make no express or implied warranties and specifically disclaim the warranties of merchantability, fitness for a particular purpose and non-infringement of third-party rights. The entire risk as to the quality and performance of the Software is with you. We do not warrant that the functions contained in the Software will meet your requirements or that the operation of the Software will be error-free.  *    6. Limitation of Liability. Our entire liability and your exclusive remedy under this EULA shall not exceed the price paid for the Software, if any. In no event shall we be liable to you for any consequential, special, incidental or indirect damages of any kind arising out of the use or inability to use the software.  *    7. Rental. You may not loan, rent, or lease the Software.  *    8. Updates and Upgrades. All updates and upgrades of the Software from a previously released version are governed by the terms and conditions of this EULA.  *    9. Support. Support for the Software Product is provided by Presta-Apps ltd. For product support, please send an email to support at info@iniweb.de  *   10. No Liability for Consequential Damages. In no event shall we be liable for any damages whatsoever (including, without limitation, incidental, direct, indirect special and consequential damages, damages for loss of business profits, business interruption, loss of business information, or other pecuniary loss) arising out of the use or inability to use the Software Product. Because some states/countries do not allow the exclusion or limitation of liability for consequential or incidental damages, the above limitation may not apply to you.  *   11. Indemnification by You. You agree to indemnify, hold harmless and defend us from and against any claims or lawsuits, including attorney's fees that arise or result from the use or distribution of the Software in violation of this Agreement.  *   *   @author    Presta-Apps Limited  *   @website   www.presta-apps.com  *   @contact   info@presta-apps.com  *   @copyright 2009-2015 Presta-Apps Ltd.  *   @license   Proprietary  * 
  */
require dirname(__FILE__).'/inixframe/loader.php'; require dirname(__FILE__).'/vendor/autoload.php'; class BulkPriceChange extends Inix2Module { protected $category; protected $id_current_category; public function __construct() { $this->name = 'bulkpricechange'; $this->tab = 'others'; $this->version = '1.0.0'; $this->displayName = 'Bulk Price Changer'; $this->description = 'Change prices of your products in a bulk'; $this->need_instance = 0; $this->ps_versions_compliancy = array('min' => '1.5.1.0', 'max' => '1.6.9.9'); parent::__construct(); if (!$this->context->controller instanceof AdminModulesController) { $this->bootstrap = true; return; } } public function getContent() { $root_category = Category::getRootCategory(); $categories = Category::getNestedCategories($root_category->id, $this->context->language->id); $select_categories = array(); $this->buildCategoryOptions($categories, $select_categories); $this->className = 'Product'; $this->object_table = 'product'; $this->object_identifier = 'id_product'; $this->lang = true; $this->explicitSelect = true; $this->bulk_actions = array( 'csv' => array( 'text' => $this->l('Save CSV File'), 'icon' => 'icon-download', ) ); if (Tools::getValue('reset_filter_category')) { $this->context->cookie->id_category_products_filter = false; } if (Shop::isFeatureActive() && $this->context->cookie->id_category_products_filter) { $category = new Category((int)$this->context->cookie->id_category_products_filter); if (!$category->inShop()) { $this->context->cookie->id_category_products_filter = false; Tools::redirectAdmin($this->context->link->getAdminLink('AdminProducts')); } } if ($id_category = (int)Tools::getValue('productFilter_cl!name')) { $this->category = new Category((int)$id_category); $_POST['productFilter_cl!name'] = $this->category->name[$this->context->language->id]; } else { if ($id_category = (int)Tools::getValue('id_category')) { $this->id_current_category = $id_category; $this->context->cookie->id_category_products_filter = $id_category; } elseif ($id_category = $this->context->cookie->id_category_products_filter) { $this->id_current_category = $id_category; } if ($this->id_current_category) { $this->category = new Category((int) $this->id_current_category); } else { $this->category = new Category(); } } $join_category = false; if (Validate::isLoadedObject($this->category) && empty($this->_filter)) { $join_category = true; } $this->_join .= '
		LEFT JOIN `'._DB_PREFIX_.'stock_available` sav ON
		(sav.`id_product` = a.`id_product` AND sav.`id_product_attribute` = 0
		'.StockAvailable::addSqlShopRestriction(null, null, 'sav').') '; $alias = 'sa'; $alias_image = 'image_shop'; $id_shop = Shop::isFeatureActive() && Shop::getContext() == Shop::CONTEXT_SHOP ? (int)$this->context->shop->id : 'a.id_shop_default'; $this->_join .= ' JOIN `'._DB_PREFIX_.'product_shop` sa ON
                        (a.`id_product` = sa.`id_product` AND sa.id_shop = '.$id_shop.')
				LEFT JOIN `'._DB_PREFIX_.'category_lang` cl
				 ON (
				        '.$alias.'.`id_category_default` = cl.`id_category`
				        AND b.`id_lang` = cl.`id_lang` AND cl.id_shop = '.$id_shop.'
				    )
				LEFT JOIN `'._DB_PREFIX_.'shop` shop ON (shop.id_shop = '.$id_shop.')
				LEFT JOIN `'._DB_PREFIX_.'image_shop` image_shop ON
				    (
				        image_shop.`id_product` = a.`id_product`
				        AND image_shop.`cover` = 1
				        AND image_shop.id_shop = '.$id_shop.'
				        )
				LEFT JOIN `'._DB_PREFIX_.'image` i ON (i.`id_image` = image_shop.`id_image`)
				LEFT JOIN `'._DB_PREFIX_.'product_download` pd ON (pd.`id_product` = a.`id_product`)'; $this->_select .= 'shop.`name` AS `shopname`, a.`id_shop_default`, '; $this->_select .= $alias_image.'.`id_image` AS `id_image`,
         cl.`name` AS `name_category`, '.$alias.'.`price`,
          0 AS `price_final`, a.`is_virtual`,
           pd.`nb_downloadable`,
            sav.`quantity` AS `sav_quantity`,
             '.$alias.'.`active`,
              IF(sav.`quantity`<=0, 1, 0) AS `badge_danger`'; if ($join_category) { $this->_join .= ' INNER JOIN `'._DB_PREFIX_.'category_product` cp ON
             (cp.`id_product` = a.`id_product` AND cp.`id_category` = '.(int)$this->category->id.') '; $this->_select .= ' , cp.`position`, '; } $this->_use_found_rows = false; $this->_group = ''; $this->fields_list = array(); $this->fields_list['id_product'] = array( 'title' => $this->l('ID'), 'align' => 'center', 'class' => 'fixed-width-xs', 'type' => 'int', 'width'=> 20, ); $this->fields_list['image'] = array( 'title' => $this->l('Image'), 'align' => 'center', 'image' => 'p', 'orderby' => false, 'filter' => false, 'search' => false ); $this->fields_list['name'] = array( 'title' => $this->l('Name'), 'filter_key' => 'b!name' ); $this->fields_list['reference'] = array( 'title' => $this->l('Reference'), 'align' => 'left', ); if (Shop::isFeatureActive() && Shop::getContext() != Shop::CONTEXT_SHOP) { $this->fields_list['shopname'] = array( 'title' => $this->l('Default shop'), 'filter_key' => 'shop!name', ); } else { $this->fields_list['name_category'] = array( 'title' => $this->l('Category'), 'type'=> 'select', 'filter_key'=>'a!id_category_default', 'list'=> $select_categories ); } $this->fields_list['price'] = array( 'title' => $this->l('Base price'), 'type' => 'price', 'align' => 'text-right', 'filter_key' => 'a!price' ); $this->fields_list['price_final'] = array( 'title' => $this->l('Final price'), 'type' => 'price', 'align' => 'text-right', 'havingFilter' => true, 'orderby' => false, 'search' => false ); if (Configuration::get('PS_STOCK_MANAGEMENT')) { $this->fields_list['sav_quantity'] = array( 'title' => $this->l('Quantity'), 'type' => 'int', 'align' => 'text-right', 'filter_key' => 'sav!quantity', 'orderby' => true, 'badge_danger' => true, ); } $this->fields_list['active'] = array( 'title' => $this->l('Status'), 'active' => 'stastus', 'filter_key' => $alias.'!active', 'align' => 'text-center', 'type' => 'bool', 'class' => 'fixed-width-sm', 'orderby' => false ); if ($join_category && (int)$this->id_current_category) { $this->fields_list['position'] = array( 'title' => $this->l('Position'), 'filter_key' => 'cp!position', 'align' => 'center', 'position' => 'position' ); } $this->fields_options = array( 'general' => array( 'title' => $this->l('Upload CSV'), 'icon' => '', '' => '', 'description' => sprintf( '%s<br />%s<br />%s<br />%s<br />', $this->l('You should use the csv file generated from this page.'), $this->l('When editing prices, avoid using any formatting.'), $this->l('The best way is to use just a formula to change the prices.'), $this->l('When saving, check explicitly of the file format is "Comma separated values (.csv)"') ), 'fields' => array( 'csv' => array( 'title'=> $this->l('Select file'), 'type'=> 'file', 'name'=> 'csv', ) ), 'submit' => array('title' => $this->l('Save')), ), ); return parent::getContent(); } public function buildCategoryOptions($category, &$categories) { foreach ($category as $c) { $categories[$c['id_category']] = str_pad( $c['name'], ( ( $c['level_depth'] * 2 ) + Tools::strlen($c['name']) + 2), " ", STR_PAD_LEFT ); if (isset($c['children'])) { $this->buildCategoryOptions($c['children'], $categories); } } } public function getList( $id_lang, $orderBy = null, $orderWay = null, $start = 0, $limit = null, $id_lang_shop = null ) { $orderByPriceFinal = ( empty($orderBy) ? ( $this->context->cookie->__get($this->table . 'Orderby') ? $this->context->cookie->__get($this->table . 'Orderby') : 'id_' . $this->table ) : $orderBy ); $orderWayPriceFinal = ( empty($orderWay) ? ( $this->context->cookie->__get($this->table . 'Orderway') ? $this->context->cookie->__get($this->table . 'Orderby') : 'ASC' ) : $orderWay ); if ($orderByPriceFinal == 'price_final') { $orderBy = 'id_' . $this->table; $orderWay = 'ASC'; } parent::getList($id_lang, $orderBy, $orderWay, $start, $limit, $this->context->shop->id); $nb = count($this->_list); if ($this->_list) { $context = $this->context->cloneContext(); $context->shop = clone( $context->shop ); for ($i = 0; $i < $nb; $i ++) { if (Context::getContext()->shop->getContext() != Shop::CONTEXT_SHOP) { $context->shop = new Shop((int) $this->_list[$i]['id_shop_default']); } $this->_list[$i]['price'] = Tools::convertPrice( $this->_list[$i]['price'], $this->context->currency, true, $this->context ); $this->_list[$i]['price_tmp'] = Product::getPriceStatic( $this->_list[$i]['id_product'], true, null, (int) Configuration::get('PS_PRICE_DISPLAY_PRECISION'), null, false, true, 1, true, null, null, null, $nothing, true, true, $context ); } } if ($orderByPriceFinal == 'price_final') { if (strtolower($orderWayPriceFinal) == 'desc') { uasort($this->_list, 'cmpPriceDesc'); } else { uasort($this->_list, 'cmpPriceAsc'); } } for ($i = 0; $this->_list && $i < $nb; $i ++) { $this->_list[$i]['price_final'] = $this->_list[$i]['price_tmp']; unset($this->_list[$i]['price_tmp']); } } public function processBulkCsv() { $products = Tools::getValue('productBox'); if (!$products || !is_array($products)) { $this->errors[] = $this->l('No products selected!'); } else { $export_data = array( array( 'id_product', 'reference', 'name', 'price' ) ); foreach ($products as $id_product) { $product = new Product($id_product, false, $this->context->language->id); if (Validate::isLoadedObject($product)) { $export_data[] = array( $product->id, $product->reference, $product->name, $product->price, ); } } if ($export_data) { try { header('Content-Type: application/csv'); header('Content-Disposition: attachment; filename=bulk_price_change_'.time().'.csv'); header('Pragma: no-cache'); $csv = new Keboola\Csv\CsvFile('php://output'); foreach ($export_data as $row) { $csv->writeRow($row); } die(); } catch (Exception $e) { $this->errors[] = $e->getMessage(); } } } } public function initContent() { $this->getLanguages(); $this->initToolbar(); $this->initPageHeaderToolbar(); if ($this->display == 'feedback') { $this->context->controller->addJqueryPlugin('fancybox'); $this->content .= $this->renderFeedback(); } elseif ($this->display == 'bugreport') { $this->context->controller->addJqueryPlugin('fancybox'); $this->content .= $this->renderBugReport(); } elseif ($this->display == 'edit' || $this->display == 'add') { if ($this->has_configuration) { if (!$this->loadObject(true)) { return; } $this->content .= $this->renderForm(); } } elseif ($this->display == 'view') { if ($this->has_configuration) { if ($this->className) { $this->loadObject(true); } $this->content .= $this->renderView(); } } elseif ($this->display == 'details') { if ($this->has_configuration) { $this->content .= $this->renderDetails(); } } elseif (!$this->ajax) { if ($this->has_configuration) { $this->content .= $this->renderKpis(); $this->content .= $this->renderOptions(); $this->content .= $this->renderList(); if ($this->required_database) { $this->content .= $this->displayRequiredFields(); } } } $this->context->smarty->assign(array( 'content' => $this->content, 'lite_display' => $this->lite_display, 'url_post' => self::$currentIndex . '&token=' . $this->token, 'show_page_header_toolbar' => $this->show_page_header_toolbar, 'page_header_toolbar_title' => $this->page_header_toolbar_title, 'title' => $this->page_header_toolbar_title, 'toolbar_btn' => $this->page_header_toolbar_btn, 'page_header_toolbar_btn' => $this->page_header_toolbar_btn )); } public function updateOptionCsv() { $upl = new Uploader('csv'); $upl->setAcceptTypes(array('csv')); $file = $upl->process(); $file= array_pop($file); if (empty($file['tmp_name'])) { $this->errors[] = $this->l('Nothing was uploaded!'); } elseif ($file['error']) { $this->errors[] = $file['error']; } else { try { $csv = new Keboola\Csv\CsvFile($file['save_path']); $header = ( $csv->getHeader() ); $csv->next(); } catch (Exception $e) { $this->errors[] = $e->getMessage(); return; } if (!array_intersect($header, array('id_product', 'reference', 'price'))) { $this->errors[] = $this->l('CSV file is missing header information!'); return; } $primary_pos = array_search('id_product', $header); $ref_pos = array_search('reference', $header); $price_pos = array_search('price', $header); while ($csv->valid()) { $row = $csv->current(); $id_product = $row[$primary_pos]; $ref = $row[$ref_pos]; $new_price = (float) $row[$price_pos]; $product = new Product($id_product); if (!Validate::isLoadedObject($product)) { $this->errors[] = sprintf( $this->l('Problem with loading product with ID: %d'), $id_product ); } elseif (!empty($product->reference) && $product->reference != $ref) { $this->errors[] = sprintf( $this->l('Product reference number does not match for product with ID: %d'), $id_product ); } elseif (!Validate::isPrice($new_price)) { $this->errors[] = sprintf( $this->l('Price is invalid for product with ID: %d'), $id_product ); } else { $product->price = $new_price; if (!$product->save()) { $this->errors[] = sprintf( $this->l('Problem with saving price for product with ID: %d'), $id_product ); } } $csv->next(); } if (!count($this->errors)) { $this->redirect_after = self::$currentIndex.'&conf=1&token='.$this->token; } } } } 